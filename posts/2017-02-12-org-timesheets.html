<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link type="application/atom+xml" rel="alternate" href="https://alexpeits.github.io/atom.xml" title="Alex&#39;s blog" />
    <link rel="shortcut icon" type="image/png" href="/images/favicon.png"/>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Raleway:ital,wght@0,400;0,600;1,400;1,600&family=Source+Serif+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap">
    <link rel="stylesheet" href="/css/default.css">
    <link rel="stylesheet" href="/css/code_pygments.css">
    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"></script>
    <script src="/js/dark-mode.js"></script>
    <script src="/js/footnotes.js" async></script>
    <script src="https://kit.fontawesome.com/f39770a341.js" crossorigin="anonymous">
    </script>
    <script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       "HTML-CSS": { linebreaks: { automatic: true } },
       SVG: { linebreaks: { automatic: true } },
       messageStyle: "none"
     });
    </script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
      type="text/javascript"
      async>
    </script>
    <title>Alex&#39;s blog - Formatting timesheet tables in org-mode</title>
  </head>
  <body>
    <header>
      <div class="logo">
        <a href="/">Alex&#39;s blog</a>
      </div>
      <nav>
          <a class="nav-link" href="/">Posts</a>
          <a class="nav-link" href="/tags.html">Tags</a>
          <a class="nav-link" href="/pages/about.html">About</a>
        <span
          id="dark-mode-toggle"
          class="far fa-moon dark-mode-disabled"
          onclick="toggleDarkMode()"></span>
      </nav>
    </header>

    <main role="main">
      <h1 id="title">Formatting timesheet tables in org-mode</h1>
      <article>
  <section class="header date">
    Posted on February 12, 2017
  </section>
  <section class="header">
    <div class="tags">
    <a class="tag" href="/tags/emacs.html">emacs</a>
    </div>
  </section>
  <section class="content">
     <div id="main"> <p><span class="box">This post is originally adapted
from <a
href="https://emacs.stackexchange.com/questions/23808/how-to-plot-summaries-of-timestamps-of-different-projects-clocking-in-and-out/23862#23862">this</a>
stackoverflow answer.</span></p>
<p>Org-mode is a great productivity tool, and has a lot of functionality
out of the box, including utilities for tracking time spent on a
task/project. For example, by pressing <code>C-c C-x C-i</code> on a
heading, a timer is added (clock-in), and by pressing
<code>C-c C-x C-o</code> the timer stops (clock-out). Org-mode also
supports adding a report with <code>org-clock-report</code>
(<code>C-c C-x C-r</code>), but, even with the customization it offers,
it is not ideal for having a fully custom report and be able to export
it to csv and whatnot.</p>
<p>Fortunately, newer versions of org-mode come with a utility called
<em>org-element</em>, which adds the ability to parse org-mode buffers
as trees. This proves really helpful to take all <code>clock</code>
elements from a buffer and put them in a table.</p>
<p>To do this, we use the following elisp code block in the respective
buffer:</p>
<div class="highlight"><pre><span></span><code><span class="o">#+</span><span class="nv">BEGIN_SRC</span><span class="w"> </span><span class="nv">elisp</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="nb">nconc</span><span class="w"></span>
<span class="w">   </span><span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;date&quot;</span><span class="w"> </span><span class="s">&quot;project&quot;</span><span class="w"> </span><span class="s">&quot;hours&quot;</span><span class="w"> </span><span class="s">&quot;task&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">   </span><span class="o">&#39;</span><span class="p">(</span><span class="nv">hline</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">ast</span><span class="w"> </span><span class="p">(</span><span class="nv">org-element-parse-buffer</span><span class="w"> </span><span class="ss">&#39;element</span><span class="p">)))</span><span class="w"></span>
<span class="w">     </span><span class="p">(</span><span class="nv">org-element-map</span><span class="w"> </span><span class="nv">ast</span><span class="w"> </span><span class="ss">&#39;clock</span><span class="w"></span>
<span class="w">       </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">val</span><span class="w"> </span><span class="p">(</span><span class="nv">org-element-property</span><span class="w"> </span><span class="ss">:value</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nv">task</span><span class="w"> </span><span class="p">(</span><span class="nv">org-element-property</span><span class="w"></span>
<span class="w">                       </span><span class="ss">:parent</span><span class="w"></span>
<span class="w">                       </span><span class="p">(</span><span class="nv">org-element-property</span><span class="w"> </span><span class="ss">:parent</span><span class="w"> </span><span class="nv">x</span><span class="p">))))</span><span class="w"></span>
<span class="w">           </span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">year</span><span class="w"> </span><span class="p">(</span><span class="nv">org-element-property</span><span class="w"> </span><span class="ss">:year-start</span><span class="w"> </span><span class="nv">val</span><span class="p">))</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="nv">month</span><span class="w"> </span><span class="p">(</span><span class="nv">calendar-month-name</span><span class="w"></span>
<span class="w">                            </span><span class="p">(</span><span class="nv">org-element-property</span><span class="w"> </span><span class="ss">:month-start</span><span class="w"> </span><span class="nv">val</span><span class="p">)))</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="nv">day</span><span class="w"> </span><span class="p">(</span><span class="nv">org-element-property</span><span class="w"> </span><span class="ss">:day-start</span><span class="w"> </span><span class="nv">val</span><span class="p">)))</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="s">&quot;%s %s, %s&quot;</span><span class="w"> </span><span class="nv">month</span><span class="w"> </span><span class="nv">day</span><span class="w"> </span><span class="nv">year</span><span class="p">))</span><span class="w"></span>
<span class="w">             </span><span class="o">,</span><span class="p">(</span><span class="nv">org-element-property</span><span class="w"> </span><span class="ss">:PROJECT</span><span class="w"> </span><span class="nv">task</span><span class="p">)</span><span class="w"></span>
<span class="w">             </span><span class="o">,</span><span class="p">(</span><span class="nv">org-element-property</span><span class="w"> </span><span class="ss">:duration</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"></span>
<span class="w">             </span><span class="o">,</span><span class="p">(</span><span class="nv">org-element-property</span><span class="w"> </span><span class="ss">:title</span><span class="w"> </span><span class="nv">task</span><span class="p">)</span><span class="w"></span>
<span class="w">             </span><span class="p">)))))</span><span class="w"></span>
<span class="w">   </span><span class="o">&#39;</span><span class="p">(</span><span class="nv">hline</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="s">&quot;total:&quot;</span><span class="w"> </span><span class="s">&quot;:=vsum(@2..@-1);T&quot;</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)))</span><span class="w"></span>
<span class="o">#+</span><span class="nv">END_SRC</span><span class="w"></span>
</code></pre></div>

<p>What this code block does is parse the buffer, and map the lambda
function over all of the <code>clock</code> elements in the buffer. For
each element, we get its value (which is the datetime range), and its
header, which contains some properties, such as the project name. The
name of the task is the header name.</p>
<p>By prepending a list, we can also add headers. At the end, a
<code>calc</code> formula can be used for adding the times to get a
total. This formula sums the current column (hence the empty strings
before and after), from the second row (not including the header), up to
the second to last row (not including the formula itself). The
<code>;T</code> after the formula instructs it to add time, rather than
numbers. Finally, the <code>hline</code> function inserts a dashed line
for making the table more presentable.</p>
<p>Suppose the buffer looks like this:</p>
<div class="highlight"><pre><span></span><code>#+BEGIN_SRC
  * project 1

  ** Task 1
    :PROPERTIES:
    :PROJECT:  project_1
    :END:
    CLOCK: [2017-06-24 Sat 19:15]--[2017-06-24 Sat 22:05] =&gt;  2:50


  ** Task 2
    :PROPERTIES:
    :PROJECT:  project_1
    :END:
    CLOCK: [2017-06-28 Wed 00:35]--[2017-06-28 Wed 03:35] =&gt;  3:00
    CLOCK: [2017-06-27 Tue 16:55]--[2017-06-27 Tue 19:00] =&gt;  2:05
    CLOCK: [2017-06-26 Mon 21:30]--[2017-06-27 Tue 01:00] =&gt;  3:30

  * project 2

  ** Task 1
    :PROPERTIES:
    :PROJECT:  project_2
    :END:
    CLOCK: [2017-06-29 Thu 15:18]--[2017-06-29 Thu 18:18] =&gt;  3:00
#+END_SRC
</code></pre></div>

<p>If the above code is wrapped in an <code>elisp</code> block and
executed (<code>C-c C-c</code>), it outputs the following table:</p>
<div class="highlight"><pre><span></span><code>#+BEGIN_SRC
  | date          | project   |             hours | task   |
  |---------------+-----------+-------------------+--------|
  | June 24, 2017 | project_1 |              2:50 | Task 1 |
  | June 28, 2017 | project_1 |              3:00 | Task 2 |
  | June 27, 2017 | project_1 |              2:05 | Task 2 |
  | June 26, 2017 | project_1 |              3:30 | Task 2 |
  | June 29, 2017 | project_2 |              3:00 | Task 1 |
  |---------------+-----------+-------------------+--------|
  |               | total:    | :=vsum(@2..@-1);T |        |
#+END_SRC
</code></pre></div>

<p>To run the formula, press <code>TAB</code> while in its cell.</p>
<p>Afterwards, the table can be exported to csv with
<code>org-table-export</code>.</p>
<p><strong>NOTE</strong>: To make all of the above work, set</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="k">setq</span><span class="w"> </span><span class="nv">org-clock-into-drawer</span><span class="w"> </span><span class="no">nil</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<p>in your config, otherwise clock entries will go into a
<code>LOGBOOK</code> drawer and I haven’t yet figured out how to parse
them from there.</p> </div>
  </section>
</article>
    </main>

    <footer>
      <span class="copyright">© 2017–present Alex Peitsinis</span>
      <a class="footer-icon" href="/atom.xml">
        <span class="fas fa-rss"></span>
      </a>
    </footer>
  </body>
</html>
