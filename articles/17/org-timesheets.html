<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Formatting timesheet tables in org-mode</title>
  <meta name="description" content="This post is originally adapted from thisstackoverflow answer.Org-mode is a great productivity tool, and has a lot of functionality out ofthe box, including ...">

  <!-- Google Fonts loaded here depending on setting in _data/options.yml true loads font, blank does not-->
  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  

  <!-- Load up MathJax script if needed ... specify in /_data/options.yml file-->
  
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true
    }
    });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  

  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-116341417-1', 'auto');
  ga('send', 'pageview');
  </script>



  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Inconsolata" />

  <link rel="stylesheet" type="text/css" href="/css/tufte.css">
  <link rel="stylesheet" type="text/css" href="/css/custom.css">
  <link rel="stylesheet" type="text/css" href="/css/friendly.css">
  <!-- <link rel="stylesheet" type="text/css" href="/css/print.css" media="print"> -->

  <link rel="canonical" href="https://alexpeits.github.io/articles/17/org-timesheets">

  <link rel="alternate" type="application/rss+xml" title="Alex's blog" href="https://alexpeits.github.io/feed.xml" />
</head>

  <body>
    <!--- Header and nav template site-wide -->
<header>
    <nav class="group">
  <a href="/"><strong>Alex's blog</strong></a>
  <div style="float: right;">
  
	
		
  	
		
  	
		
		    
		      <a href="/">Alex's blog</a>
		    
	    
  	
		
		    
		      <a href="/about/">About</a>
		    
	    
  	
		
		    
		      <a href="/talks/">Talks</a>
		    
	    
  	
		
		    
		      <a href="/tags/">Tags</a>
		    
	    
  	
    </div>
	</nav>
</header>
<br>
<br>
<br>

    <article class="group">
      <h1>Formatting timesheet tables in org-mode</h1>
<p class="subtitle" style="display: inline; padding-right: 0.6rem;">February 12, 2017</p>

&bull;
<span style="font-size: 140%; padding-left: 0.6rem;" onclick="loadDisqusComments()">
  <a href="#disqus_thread" style="color: green;" class="group">
    <span class="disqus-comment-count"
          data-disqus-identifier="https://alexpeits.github.io/articles/17/org-timesheets">
    </span>
  </a>
</span>


<p class="note">This post is originally adapted from <a href="https://emacs.stackexchange.com/questions/23808/how-to-plot-summaries-of-timestamps-of-different-projects-clocking-in-and-out/23862#23862">this</a>
stackoverflow answer.</p>

<p>Org-mode is a great productivity tool, and has a lot of functionality out of
the box, including utilities for tracking time spent on a task/project. For
example, by pressing <code class="highlighter-rouge">C-c C-x C-i</code> on a heading, a timer is added (clock-in),
and by pressing <code class="highlighter-rouge">C-c C-x C-o</code> the timer stops (clock-out). Org-mode also
supports adding a report with <code class="highlighter-rouge">org-clock-report</code> (<code class="highlighter-rouge">C-c C-x C-r</code>), but, even
with the customization it offers, it is not ideal for having a fully custom
report and be able to export it to csv and whatnot.<!--more--></p>

<p>Fortunately, newer versions of org-mode come with a utility called
<em>org-element</em>, which adds the ability to parse org-mode buffers as trees. This
proves really helpful to take all <code class="highlighter-rouge">clock</code> elements from a buffer and put them
in a table.</p>

<p>To do this, we use the following elisp code block in the respective buffer:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#+BEGIN_SRC elisp
  (nconc
   '(("date" "project" "hours" "task"))
   '(hline)
   (let ((ast (org-element-parse-buffer 'element)))
     (org-element-map ast 'clock
       (lambda (x)
         (let* ((val (org-element-property :value x))
                (task (org-element-property :parent (org-element-property :parent x))))
           `(,(let ((year (org-element-property :year-start val))
                    (month (calendar-month-name
                            (org-element-property :month-start val)))
                    (day (org-element-property :day-start val)))
                ;; (insert (org-element-property :raw-value val))
                (format "%s %s, %s" month day year))
             ,(org-element-property :PROJECT task)
             ,(org-element-property :duration x)
             ,(org-element-property :title task)
             )))))
   '(hline)
   '(("" "total:" ":=vsum(@2..@-1);T" "")))
#+END_SRC
</code></pre></div></div>

<p>What this code block does is parse the buffer, and map the lambda function over all of the <code class="highlighter-rouge">clock</code> elements
in the buffer. For each element, we get its value (which is the datetime range), and its header, which contains
some properties, such as the project name. The name of the task is the header name.</p>

<p>By prepending a list, we can also add headers. At the end, a <code class="highlighter-rouge">calc</code> formula can be used for adding the times
to get a total. This formula sums the current column (hence the empty strings before and after), from the
second row (not including the header), up to the second to last row (not including the formula itself). The
<code class="highlighter-rouge">;T</code> after the formula instructs it to add time, rather than numbers. Finally, the <code class="highlighter-rouge">hline</code> function inserts
a dashed line for making the table more presentable.</p>

<p>Suppose the buffer looks like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#+BEGIN_SRC 
  * project 1

  ** Task 1
    :PROPERTIES:
    :PROJECT:  project_1
    :END:
    CLOCK: [2017-06-24 Sat 19:15]--[2017-06-24 Sat 22:05] =&gt;  2:50


  ** Task 2
    :PROPERTIES:
    :PROJECT:  project_1
    :END:
    CLOCK: [2017-06-28 Wed 00:35]--[2017-06-28 Wed 03:35] =&gt;  3:00
    CLOCK: [2017-06-27 Tue 16:55]--[2017-06-27 Tue 19:00] =&gt;  2:05
    CLOCK: [2017-06-26 Mon 21:30]--[2017-06-27 Tue 01:00] =&gt;  3:30

  * project 2

  ** Task 1
    :PROPERTIES:
    :PROJECT:  project_2
    :END:
    CLOCK: [2017-06-29 Thu 15:18]--[2017-06-29 Thu 18:18] =&gt;  3:00
#+END_SRC
</code></pre></div></div>

<p>If the above code is wrapped in an <code class="highlighter-rouge">elisp</code> block and executed (<code class="highlighter-rouge">C-c C-c</code>), it outputs the
following table:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#+BEGIN_SRC 
  | date          | project   |             hours | task   |
  |---------------+-----------+-------------------+--------|
  | June 24, 2017 | project_1 |              2:50 | Task 1 |
  | June 28, 2017 | project_1 |              3:00 | Task 2 |
  | June 27, 2017 | project_1 |              2:05 | Task 2 |
  | June 26, 2017 | project_1 |              3:30 | Task 2 |
  | June 29, 2017 | project_2 |              3:00 | Task 1 |
  |---------------+-----------+-------------------+--------|
  |               | total:    | :=vsum(@2..@-1);T |        |
#+END_SRC
</code></pre></div></div>

<p>To run the formula, press <code class="highlighter-rouge">TAB</code> while in its cell.</p>

<p>Afterwards, the table can be exported to csv with <code class="highlighter-rouge">org-table-export</code>.</p>




  
  <hr class="slender">
  <section class="comments">
    <div id="comments-container">
      <h2>
        <a href="#disqus_thread" onClick="loadDisqusComments()">Click to load comments</a>
      </h2>
    </div>
    
  <div id="disqus_thread">
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "https://alexpeits.github.io/articles/17/org-timesheets";
    this.page.identifier = "https://alexpeits.github.io/articles/17/org-timesheets";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document;
    var cc = d.getElementById('comments-container');
    cc.innerHTML = '<h2>Comments</h2><br>';
    var s = d.createElement('script');
    s.src = '//alexpeits-github-io.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>




    </article>
    <span class="print-footer">Formatting timesheet tables in org-mode - February 12, 2017 - Alex Peitsinis</span>
    <footer>
  <hr class="slender">
  <ul class="footer-links">
    <!--<li><a href="mailto:hate@spam.net"><span class="icon-mail"></span></a></li>    -->
    
      <li>
        <a href="//github.com/alexpeits"><span class="icon-github"></span></a>
      </li>
    
      <li>
        <a href="//www.twitter.com/alexpeits"><span class="icon-twitter"></span></a>
      </li>
    
      <li>
        <a href="/feed.xml"><span class="icon-feed"></span></a>
      </li>
      
  </ul>
<div class="credits">
<span>&copy; 2019 &nbsp;&nbsp;ALEX PEITSINIS</span></br> <br>
<span>Created with <a href="//jekyllrb.com">Jekyll</a> and <a href="//github.com/clayh53/tufte-jekyll">tufte-jekyll</a>.</span> 
</div>  
</footer>

  </body>

<script id="dsq-count-scr" src="//alexpeits-github-io.disqus.com/count.js" async></script>
</html>
